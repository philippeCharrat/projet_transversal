C51 COMPILER V9.59.0.0   MASTER_MAIN                                                       04/04/2021 17:16:12 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE MASTER_MAIN
OBJECT MODULE PLACED IN .\Objects\MASTER_Main.obj
COMPILER INVOKED BY: D:\Keil\C51\BIN\C51.EXE MASTER_Main.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Lis
                    -tings\MASTER_Main.lst) TABS(2) OBJECT(.\Objects\MASTER_Main.obj)

line level    source

   1          //-----------------------------------------------------------------------------
   2          // F0-M01.c
   3          //
   4          // Dernière Modification : 15/03/2021 (aucune erreur déclarées et 3 warnings) 
   5          // Auteur : 
   6          //  - Maxime LERICHE
   7          //  - Philippe CHARRAT
   8          // TODO : 
   9          //  - fonction d'erreur 
  10          //  - Convertion Struct to String 
  11          //  - 
  12          //-----------------------------------------------------------------------------
  13          
  14          // Import des bibliothèques ---
  15          #include <C8051F020.h>
  16          #include <stdio.h>
  17          #include <string.h>
  18          #include <stdlib.h>
  19          #include "c8051F020_SFR16.h"
  20          
  21          #include "MASTER_Config_Globale.h"
  22          
  23          #include "FO_M1__Structures_COMMANDES_INFORMATIONS_CentraleDeCommande.h"
  24          #include "FO_M2__Structures_COMMANDES_INFORMATIONS_Serializer.h"
  25          
  26          #include <F0_M1.h>
  27          #include <F0_M2.h>
  28          #include <F0_M3.h>
  29          #include <F0_M4.h>
  30          // ---
  31          
  32          // Prototypes de Fonctions
  33          
  34          // Variables g�n�rales
  35          
  36          // Partie : Interruption
  37            
  38          //Variables globales
  39          char temps;
  40          char demande_pids = 0;
  41          
  42          // 
  43          unsigned int distance;
  44          
  45          // Strucutre 
  46          struct COMMANDES commandeCentraleCommande = {
  47              Epreuve_non,
  48              Mouvement_non, 20, 0, 0, 0,
  49              ACQ_non, 0,
  50              DCT_non, 0,
  51              Lumiere_non, 0, 0, 0, 0,
  52              Servo_non, 0,
  53              Energie_non,
  54              Position_non, 0, 0, 0,
C51 COMPILER V9.59.0.0   MASTER_MAIN                                                       04/04/2021 17:16:12 PAGE 2   

  55              Photo_non, 0, 0
  56            };
  57          
  58          struct INFORMATIONS informationsCentraleCommande = {
  59              Invite_non, "Message d'invite",
  60              BUT_Atteint_non,
  61              BUT_Servo_non,
  62              DCT_Obst_non, 0, 0,
  63              RESULT_Courant_non, 0,
  64              RESULT_Energie_non, 0,
  65              RESULT_Position_non, 0, 0, 0,
  66              Aux_non, "???"
  67            };
  68          
  69          struct COMMANDES_SERIALIZER commandeSerializer = {
  70            Commande_non,
  71            0,       
  72            0,
  73            0,              
  74            0,         
  75            0,           
  76            0,   
  77            0,        
  78            0,  
  79            };
  80          
  81          struct INFORMATIONS_SERIALIZER informationsSerializer = {
  82            Reponse_non,     
  83            0,           
  84            0,                
  85            0,                 
  86            0,                    
  87            0,                    
  88            0,                 
  89            0,                   
  90            0,          
  91            0,       
  92            };
  93          //-----------------------------------------------------------------------------
  94          // MAIN Routine
  95          //-----------------------------------------------------------------------------
  96          
  97          void main (void) {
  98   1        // Appel des configurations globales
  99   1        Init_Device();
 100   1        Send_string_UART0("SYSTEME OK !\n\0");
 101   1      
 102   1        while (1)
 103   1        {
 104   2          commandeCentraleCommande = recuperation_structure_commande(commandeCentraleCommande);
 105   2          informationsSerializer = recuperation_structure_serializer(informationsSerializer);
 106   2      
 107   2          // ------------------------- Gestion de l'epreuvre ---------------------------------------------
 108   2          
 109   2          switch (commandeCentraleCommande.Etat_Epreuve)
 110   2              {
 111   3              case epreuve1:
 112   3            informationsCentraleCommande.Etat_Invite = Invite_oui;
 113   3            informationsCentraleCommande.MSG_Invit = "Epreuve 1 start !";
 114   3            
 115   3            commandeCentraleCommande.Etat_Epreuve = Fin_Epreuve;
 116   3                  break;
C51 COMPILER V9.59.0.0   MASTER_MAIN                                                       04/04/2021 17:16:12 PAGE 3   

 117   3              case epreuve2:
 118   3            informationsCentraleCommande.Etat_Invite = Invite_oui;
 119   3            informationsCentraleCommande.MSG_Invit = "Epreuve 2 start !";
 120   3            
 121   3            commandeCentraleCommande.Etat_Epreuve = Fin_Epreuve;
 122   3                  break;
 123   3              case epreuve3:
 124   3            informationsCentraleCommande.Etat_Invite = Invite_oui;
 125   3            informationsCentraleCommande.MSG_Invit = "Epreuve 3 start !";
 126   3            
 127   3            commandeCentraleCommande.Etat_Epreuve = Fin_Epreuve;
 128   3                  break;
 129   3              case epreuve4:
 130   3            informationsCentraleCommande.Etat_Invite = Invite_oui;
 131   3            informationsCentraleCommande.MSG_Invit = "Epreuve 4 start !";
 132   3            
 133   3            commandeCentraleCommande.Etat_Epreuve = Fin_Epreuve;
 134   3                  break;
 135   3              case epreuve5:
 136   3            informationsCentraleCommande.Etat_Invite = Invite_oui;
 137   3            informationsCentraleCommande.MSG_Invit = "Epreuve 5 start !";
 138   3            
 139   3            commandeCentraleCommande.Etat_Epreuve = Fin_Epreuve;
 140   3                  break;
 141   3              case epreuve6:
 142   3            informationsCentraleCommande.Etat_Invite = Invite_oui;
 143   3            informationsCentraleCommande.MSG_Invit = "Epreuve 6 start !";
 144   3            
 145   3            commandeCentraleCommande.Etat_Epreuve = Fin_Epreuve;
 146   3                  break;
 147   3              case epreuve7:
 148   3            informationsCentraleCommande.Etat_Invite = Invite_oui;
 149   3            informationsCentraleCommande.MSG_Invit = "Epreuve 7 start !";
 150   3            
 151   3            commandeCentraleCommande.Etat_Epreuve = Fin_Epreuve;
 152   3                  break;
 153   3              case epreuve8:
 154   3            informationsCentraleCommande.Etat_Invite = Invite_oui;
 155   3            informationsCentraleCommande.MSG_Invit = "Epreuve 8 start !";
 156   3            
 157   3            commandeCentraleCommande.Etat_Epreuve = Fin_Epreuve;
 158   3                  break;
 159   3              case Fin_Epreuve:
 160   3            informationsCentraleCommande.Etat_Invite = Invite_oui;
 161   3            informationsCentraleCommande.MSG_Invit = "Epreuve end !";
 162   3            
 163   3            commandeCentraleCommande.Etat_Epreuve = Epreuve_non;
 164   3                  break;
 165   3              default:
 166   3                  break;
 167   3              }
 168   2          
 169   2          // ------------------------- Gestion du type de mouvement ---------------------------------------------
 170   2      
 171   2          if (commandeCentraleCommande.Etat_Mouvement == Stopper)
 172   2          {
 173   3              commandeSerializer.Etat_Commande = Stop;
 174   3              commandeCentraleCommande.Etat_Mouvement = Mouvement_non;
 175   3          }
 176   2          else if(commandeCentraleCommande.Etat_Mouvement != Mouvement_non)
 177   2          {
 178   3            //Demande si les moteurs sont deja utilises
C51 COMPILER V9.59.0.0   MASTER_MAIN                                                       04/04/2021 17:16:12 PAGE 4   

 179   3            if(demande_pids == 0)
 180   3            {
 181   4              commandeSerializer.Etat_Commande = Pids;
 182   4              demande_pids = 1;
 183   4            }
 184   3            // Si on recu la reponse du if precedent
 185   3            else if(informationsSerializer.Etat_Response == Rep_pids)
 186   3            {
 187   4              demande_pids = 0;
 188   4              informationsSerializer.Etat_Response = Reponse_non;
 189   4              if(informationsSerializer.Read_Pids == 0)
 190   4              {
 191   5                switch(commandeCentraleCommande.Etat_Mouvement)
 192   5                {
 193   6                case Avancer:
 194   6                  commandeSerializer.Etat_Commande = mogo_1_2;
 195   6                  commandeSerializer.Vitesse_Mot1 = (commandeCentraleCommande.Vitesse*28)/100;
 196   6                  commandeSerializer.Vitesse_Mot2 = (commandeCentraleCommande.Vitesse*28)/100;
 197   6      
 198   6                  commandeCentraleCommande.Etat_Mouvement = Mouvement_non;
 199   6                  break;
 200   6                case Reculer:
 201   6                  commandeSerializer.Etat_Commande = mogo_1_2;
 202   6                  commandeSerializer.Vitesse_Mot1 = -(commandeCentraleCommande.Vitesse*28)/100;
 203   6                  commandeSerializer.Vitesse_Mot2 = -(commandeCentraleCommande.Vitesse*28)/100;
 204   6      
 205   6                  commandeCentraleCommande.Etat_Mouvement = Mouvement_non;
 206   6                  break;
 207   6                case Rot_90D:
 208   6                  commandeSerializer.Etat_Commande = digo_1_2;
 209   6                  commandeSerializer.Ticks_mot1 = (90/180) * 100;
 210   6                  commandeSerializer.Ticks_mot2 = (90/180) * 100;
 211   6                  commandeSerializer.Vitesse_Mot1 = 10;
 212   6                  commandeSerializer.Vitesse_Mot2 = -10;
 213   6      
 214   6                  commandeCentraleCommande.Etat_Mouvement = Mouvement_non;
 215   6                  break;
 216   6                case Rot_90G:
 217   6                  commandeSerializer.Etat_Commande = digo_1_2;
 218   6                  commandeSerializer.Ticks_mot1 = (90/180) * 100;
 219   6                  commandeSerializer.Ticks_mot2 = (90/180) * 100;
 220   6                  commandeSerializer.Vitesse_Mot1 = -10;
 221   6                  commandeSerializer.Vitesse_Mot2 = 10;
 222   6      
 223   6                  commandeCentraleCommande.Etat_Mouvement = Mouvement_non;
 224   6                  break;
 225   6                case Rot_180D:
 226   6                  commandeSerializer.Etat_Commande = digo_1_2;
 227   6                  commandeSerializer.Ticks_mot1 = 100;
 228   6                  commandeSerializer.Ticks_mot2 = 100;
 229   6                  commandeSerializer.Vitesse_Mot1 = 10;
 230   6                  commandeSerializer.Vitesse_Mot2 = -10;
 231   6      
 232   6                  commandeCentraleCommande.Etat_Mouvement = Mouvement_non;
 233   6                  break;
 234   6                case Rot_180G:
 235   6                  commandeSerializer.Etat_Commande = digo_1_2;
 236   6                  commandeSerializer.Ticks_mot1 = 100;
 237   6                  commandeSerializer.Ticks_mot2 = 100;
 238   6                  commandeSerializer.Vitesse_Mot1 = -10;
 239   6                  commandeSerializer.Vitesse_Mot2 = 10;
 240   6      
C51 COMPILER V9.59.0.0   MASTER_MAIN                                                       04/04/2021 17:16:12 PAGE 5   

 241   6                  commandeCentraleCommande.Etat_Mouvement = Mouvement_non;
 242   6                  break;
 243   6                case Rot_AngD:
 244   6                  commandeSerializer.Etat_Commande = digo_1_2;
 245   6                  commandeSerializer.Ticks_mot1 = (abs(commandeCentraleCommande.Angle)/180) * 100;
 246   6                  commandeSerializer.Ticks_mot2 = (abs(commandeCentraleCommande.Angle)/180) * 100;
 247   6                  commandeSerializer.Vitesse_Mot1 = 10;
 248   6                  commandeSerializer.Vitesse_Mot2 = -10;
 249   6      
 250   6                  commandeCentraleCommande.Etat_Mouvement = Mouvement_non;
 251   6                  break;
 252   6                case Rot_AngG:
 253   6                  commandeSerializer.Etat_Commande = digo_1_2;
 254   6                  commandeSerializer.Ticks_mot1 = (abs(commandeCentraleCommande.Angle)/180) * 100;
 255   6                  commandeSerializer.Ticks_mot2 = (abs(commandeCentraleCommande.Angle)/180) * 100;
 256   6                  commandeSerializer.Vitesse_Mot1 = -10;
 257   6                  commandeSerializer.Vitesse_Mot2 = 10;
 258   6      
 259   6                  commandeCentraleCommande.Etat_Mouvement = Mouvement_non;
 260   6                  break;
 261   6                case Depl_Coord:
 262   6                  // A faire !
 263   6                  if(commandeCentraleCommande.Pos_Coord_X = commandeCentraleCommande.Coord_X)
 264   6                  {
 265   7                    if(commandeCentraleCommande.Pos_Coord_Y = commandeCentraleCommande.Coord_Y)
 266   7                    {
 267   8                      if(commandeCentraleCommande.Pos_Angle = commandeCentraleCommande.Angle)
 268   8                      {
 269   9                        commandeCentraleCommande.Etat_Mouvement = Mouvement_non;
 270   9                      }
 271   8                    }
 272   7                  }
 273   6                  break;
 274   6                default:
 275   6                  break;
 276   6                }
 277   5              }
 278   4            }
 279   3            else
 280   3            {
 281   4              commandeSerializer.Etat_Commande = Commande_non;
 282   4            }
 283   3          }
 284   2          switch (commandeCentraleCommande.Etat_ACQ_Son)
 285   2              {
 286   3              case ACQ_oui:
 287   3            //AS1   
 288   3                  break;
 289   3              default:
 290   3                  break;
 291   3              }
 292   2      
 293   2              switch (commandeCentraleCommande.Etat_DCT_Obst)
 294   2              {
 295   3              case oui_180:
 296   3            //M3 & M4
 297   3                  break;
 298   3              case oui_360:
 299   3            //M3 & M4
 300   3                  break;
 301   3              default:
 302   3                  break;
C51 COMPILER V9.59.0.0   MASTER_MAIN                                                       04/04/2021 17:16:12 PAGE 6   

 303   3              }
 304   2      
 305   2              switch (commandeCentraleCommande.Etat_Lumiere)
 306   2              {
 307   3              case Allumer:
 308   3            //MS1 && S6 && S1
 309   3                  break;
 310   3              case Eteindre:
 311   3            //MS1 && S6 && S1
 312   3                  break;
 313   3              default:
 314   3                  break;
 315   3              }
 316   2      
 317   2              switch (commandeCentraleCommande.Etat_Servo)
 318   2              {
 319   3              case Servo_H:
 320   3                  //M3
 321   3                  break;
 322   3              case Servo_V:
 323   3            //S3
 324   3                  break;
 325   3              default:
 326   3                  break;
 327   3              }
 328   2      
 329   2              switch (commandeCentraleCommande.Etat_Energie)
 330   2              {
 331   3              case Mesure_I:
 332   3            //M5
 333   3                  break;
 334   3              case Mesure_E:
 335   3            //M5
 336   3                  break;
 337   3              default:
 338   3                  break;
 339   3              }
 340   2      
 341   2          switch (commandeCentraleCommande.Etat_Position)
 342   2              {
 343   3              case Init_Position:
 344   3      
 345   3                  break;
 346   3              case Demande_Position:
 347   3            //envoi la position actuelle
 348   3            informationsCentraleCommande.Etat_RESULT_Position = RESULT_Position_oui;
 349   3            commandeCentraleCommande.Etat_Position = Position_non;
 350   3                  break;
 351   3              default:
 352   3                  break;
 353   3              }
 354   2      
 355   2              switch (commandeCentraleCommande.Etat_Photo)
 356   2              {
 357   3              case Photo_1:
 358   3      
 359   3                  break;
 360   3              case Photo_Multiple:
 361   3      
 362   3                  break;
 363   3              case Photo_continue:
 364   3      
C51 COMPILER V9.59.0.0   MASTER_MAIN                                                       04/04/2021 17:16:12 PAGE 7   

 365   3                  break;
 366   3              case Photo_stop:
 367   3      
 368   3                  break;
 369   3              default:
 370   3                  break;
 371   3              }
 372   2            Convertion_A_to_S(informationsCentraleCommande);
 373   2        }
 374   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    933    ----
   CONSTANT SIZE    =    194    ----
   XDATA SIZE       =     90    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
